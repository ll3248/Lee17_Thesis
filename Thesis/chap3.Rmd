---
header-includes:
- \usepackage{graphicx,latexsym}
- \usepackage{amssymb,amsthm,amsmath}
- \usepackage{longtable,booktabs,setspace}
---

<!--
You can delete the header-includes (lines 3-6 above) if you like and also the chunk below since it is loaded in the skeleton.Rmd file.  They are included so that chap3.Rmd will compile by itself when you hit Knit PDF.
-->

```{r include_packages_2, include = FALSE}
# This chunk ensures that the acstats package is
# installed and loaded. This acstats package includes
# the template files for the thesis and also two functions
# used for labeling and referencing
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")
if(!require(dplyr))
    install.packages("dplyr", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("ggplot2", repos = "http://cran.rstudio.com")
if(!require(acstats)){
  library(devtools)
  devtools::install_github("Amherst-Statistics/acstats")
  }
library(acstats)
```


```{r setupch3, include = FALSE}
library(sand)
library(igraph)
library(network)
library(sna)
library(statnet)
library(ergm)
library(xtable)

options(xtable.comment = FALSE)
options(digits = 4)
```

# Simulation Study

## Description of Our Dataset 

Here we will use a subset of the Facebook network to fit graph models to the observed model and assess each one’s accuracy. This Facebook network was compiled by Stanford University and accessed through its Stanford Large Network Data Collection (SNAP). For more information, please see @snapnets. Our subset of the Facebook network was presented as an edge list. The social network is one giant component composed of $4039$ nodes and $88234$ edges, which represent $4039$ anonymous users and the $88234$ connections between them, respectively.[^3] This network is simple and undirected, meaning the network consists of established, mutual friendships. The first column of values in Table 3.1 below describes some characteristics of this network. We use the `igraph`, `sna`, `network`, `ergm`, `statnet` packages in our study. Please see, @igraphpackage, @butts2008social, @networkpackagemanual, @networkpackagearticle, @ergmpackagemanual, @ergmpackagearticle, @statnetpackagemanual, @statnetpackagearticle, and @intergraphpackagemanual for more details.

[^3]: Some of our network statistics that we calculated in R did not match those seen in the websites. For example, we calculated the diameter and transitivity of this Facebook component to be $17$ and $0.617$, respectively. However, the SNAP website reports the diameter and "average clustering coefficient" to be $8$ and $0.6055$, respectively. However, other values, such as node and edge count, as well as the number of triangles, are equal. While SNAP's algorithm used to calculate their network statistics is unclear, for the purposes of this simulation study, we will be using the values that we calculated from the Facebook component to compare with those generated from our graph models. 

```{r loadfbdata, message = FALSE, echo = FALSE, eval = TRUE}
setwd("~/STAT495-Lee/LeeThesis/data")

#edge list
facebookcombined <- read.table(gzfile("facebook_combined.txt.gz"), header = F)

#igraph object
fbel <- graph.data.frame(facebookcombined)
```

```{r fbeldescstats, message = FALSE, echo = FALSE, eval = FALSE}
length(unique(c(facebookcombined$V2, facebookcombined$V1))); vcount(fbel)
#number of vertices: 4039
nrow(facebookcombined); ecount(fbel)
#number of edges: 88234
sum(count_triangles(fbel))/3 
#number of unique triangles (up to ordering): 1612010

transitivity(fbel, type="localaverage") #0.6170038
diameter(fbel) #17
average.path.length(fbel) #4.337744

mean(igraph::degree(fbel)) 
#average degree centrality: 43.69101
mean(igraph::betweenness(fbel)) 
#average betweenness centrality: 2072.642
mean(igraph::closeness(fbel)) 
#average closeness centrality: 8.881448e-08
mean(igraph::eigen_centrality(fbel)$vector) 
#average eigenvector centrality 0.04047316
```

```{r fbelplot, eval = FALSE, echo = FALSE, include = FALSE}
plot(fbel, 
     edge.arrow.size = 0, 
     edge.width = 0.05, 
     vertex.label = NA, 
     vertex.size = 5)
```

![Overview of our component of the Facebook network](figure/31fbelplot.pdf)

## Generating Random Graphs

For each model, we created graphs of parable magnitude using some of the information calculated from the our Facebook network. We compared selected statistical network statistics of the Facebook network with that of the graphs we generate to see if the observed network and the simulated graphs have similar characteristics. We explain the process of generating one random graph for each model in the sections below. We simulated $1000$ random graphs for each model and recorded the statistics such as transitivity, diameter, and average centrality values. Because we had $1000$ values (one for each random graph for each model), we then recorded the average of these values. This means that for statistics such as average degree, we were interested in recording an average of the averages. The first column of `r ref("erwsdescstats", type="table")` shows the network statisitcs we were interested in and the average statistics recorded under each model as well as the standard deviation. 

### Using the Erdős-Rényi Model

The Erdős-Rényi model only takes in two parameters, which are the number of nodes and the fixed probability of edge formation. The number of edges is already given as $4039$, but to find the probability, we estimate this by taking the number of obsevred edges and divide it by the number of possible edges. For a graph $G$, this estimated probability is

$$\hat{p} = \frac {N_{E}} {{N_{V} \choose 2}}$$

where $N_{E}$ is the number of edges in  $G$, $V_G$ is the number of nodes in $G$. 

Thus, in order to simulate one graph from this model, we must look at each possible edge among the $4039$ nodes and determine if an edge will form based on the given probability. 

```{r erdosrenyisim, eval = FALSE, echo = FALSE}
set.seed(499)

numsim <- 1000

g.er.fbel.ecount <- rep(NA, numsim)
g.er.fbel.coef <- rep(NA, numsim)
g.er.fbel.apl <- rep(NA, numsim)
g.er.fbel.dia <- rep(NA, numsim)
g.er.fbel.avgdeg <- rep(NA, numsim)
g.er.fbel.avgbtwcen <- rep(NA, numsim)
g.er.fbel.avgclocen <- rep(NA, numsim)
g.er.fbel.avgeigveccen <- rep(NA, numsim)

#probability used in for-loop below
p = ecount(fbel)/choose(vcount(fbel), 2)

for (i in 1:numsim) {
  # n = number of vertices, p = probability of a link
  #p is caluclated as number of edges over number of possible edges
  #p is then (4039 choose 2) as calculated above 
  #igraph object
  g.er.fbel <- erdos.renyi.game(n = vcount(fbel), p)
  
  #observe the network statistics for this simulated graph
  g.er.fbel.ecount[i] <- ecount(g.er.fbel)
  g.er.fbel.coef[i] <- transitivity(g.er.fbel, type="localaverage")
  g.er.fbel.apl[i] <- average.path.length(g.er.fbel)
  g.er.fbel.dia[i] <- diameter(g.er.fbel)
  g.er.fbel.avgdeg[i] <- mean(igraph::degree(g.er.fbel))
  g.er.fbel.avgbtwcen[i] <- mean(igraph::betweenness(g.er.fbel))
  g.er.fbel.avgclocen[i] <- mean(igraph::closeness(g.er.fbel))
  g.er.fbel.avgeigveccen[i] <- mean(igraph::eigen_centrality(g.er.fbel)$vector)
}

#save values as dataframe
g.er.fbel <- as.data.frame(cbind(g.er.fbel.ecount, g.er.fbel.coef, 
                                 g.er.fbel.apl, g.er.fbel.dia, 
                                 g.er.fbel.avgdeg, g.er.fbel.avgbtwcen, 
                                 g.er.fbel.avgclocen, g.er.fbel.avgeigveccen))
```


### Using the Watts-Strogatz Model

The Watts-Strogatz model takes in the following: the number of nodes $N_{V}$, the number of starting neighbors $r$, and the probability of an edge to be rewired $p$. However, instead of rewiring our edges with a fixed probability, we will instead randomly add edges until we have approximately the same number as our observed network. To do this, we start with a lattice with $4039$ nodes and assign a number of edges to the nodes equal to the smallest degree seen in our Facebook network (which we find to be $1$). This is our starting number of neighbors for each node. In this situation, $p = 0$. We then randomly add edges equal to the difference between the our starting lattice and the observed network. That is, we add $88234 - 4039 = 84195$ edges to our lattice. Finally, we simplify our simulated graph to eliminate multi-edges and loops.  Since there are $4039 \choose 2$ edges to choose from, intuitively, we can see that having many multi-edges or loops will be infrequent. This makes up one simulated graph from the model. 

```{r wattsstrogatzsim, eval = FALSE, echo = FALSE}
set.seed(499)

numsim <- 1000

g.ws.fbel.ecount <- rep(NA,numsim)
g.ws.fbel.coef <- rep(NA, numsim)
g.ws.fbel.apl <- rep(NA, numsim)
g.ws.fbel.dia <- rep(NA, numsim)
g.ws.fbel.avgdeg <- rep(NA, numsim)
g.ws.fbel.avgbtwcen <- rep(NA, numsim)
g.ws.fbel.avgclocen <- rep(NA, numsim)
g.ws.fbel.avgeigveccen <- rep(NA, numsim)

for (i in 1:numsim) {
  #create a lattice with the same number of vertices as 'fbel'
  #let the starting number of neighbors be 
   #equal to the minimum vertex degree of 'fbel'
  g.ws.fbel <- watts.strogatz.game(dim = 1, size = vcount(fbel), 
                                   nei = min(degree(fbg)), p = 0)
  
  #generate list of random vertex values to add edges to lattice
  #each pair in the list represents one random edge
  randomedgepairs <- sample(1:vcount(fbel), 2*(ecount(fbel)-vcount(fbel)), 
                            replace=TRUE)
  g.ws.fbel.pre <- add_edges(g.ws.fbel, randomedgepairs)
    
  
  #igraph object
  g.ws.fbel <- simplify(g.ws.fbel.pre)
  
  #observe the network statistics for this simulated graph
  g.ws.fbel.ecount[i] <- ecount(g.ws.fbel)
  g.ws.fbel.coef[i] <- transitivity(g.ws.fbel, type="localaverage")
  g.ws.fbel.apl[i] <- average.path.length(g.ws.fbel)
  g.ws.fbel.dia[i] <- diameter(g.ws.fbel)
  g.ws.fbel.avgdeg[i] <- mean(igraph::degree(g.ws.fbel))
  g.ws.fbel.avgbtwcen[i] <- mean(igraph::betweenness(g.ws.fbel))
  g.ws.fbel.avgclocen[i] <- mean(igraph::closeness(g.ws.fbel))
  g.ws.fbel.avgeigveccen[i] <- mean(igraph::eigen_centrality(g.ws.fbel)$vector)
}

#save values as dataframe
g.ws.fbel <- as.data.frame(cbind(g.ws.fbel.ecount, g.ws.fbel.coef, 
                                 g.ws.fbel.apl, g.ws.fbel.dia, 
                                 g.ws.fbel.avgdeg, g.ws.fbel.avgbtwcen, 
                                 g.ws.fbel.avgclocen, g.ws.fbel.avgeigveccen))
```


### Using ERGMs

```{r ergmmods, eval = FALSE, echo = FALSE}
#needs an object of class network
#this should be the same as Erdős-Rényi
g.ergm1.fbg <- ergm(fbg ~ edges)

set.seed(499)
g.ergm1.fbg.sim <- simulate(g.ergm1.fbg, numsim=1000)



g.ergm2.fbg <- ergm(fbg ~ edges+triangle)

set.seed(499)
g.ergm2.fbg.sim <- simulate(g.ergm2.fbg, numsim=1000)
```



\clearpage


-------------------------------------------------------------------------------------------------------------
Network Statistic                  Observed     Erdős-Rényi                   Watts-Strogatz
---------------------------------- ------------ ----------------------------- -----------------------------
Transitivity                       0.617          0.0108 $\pm$ 0.0001           0.0107 $\pm$ 9.135e-05
  
Average Path Length                4.338          2.606 $\pm$ 0.002             2.6093 $\pm$ 0.0002           
  
Diameter                           17             3.96 $\pm$ 0.21               3.95 $\pm$ 0.22
  
Average Degree                     43.691         43.69 $\pm$ 0.14              43.45 $\pm$ 0.01 
  
Average Betweenness Centrality     2072.642       3242 $\pm$ 4                  3249.2 $\pm$ 0.4 
  
Average Closeness Centrality       8.881e-08      9.507e-05 $\pm$ 7.230e-08     9.494e-05 $\pm$ 7.319e-09 
  
Average Eigenvector Centrality     0.040          0.6202 $\pm$ 0.0224           0.6235 $\pm$ 0.0227       
---------------------------------- -------------- ----------------------------- -----------------------------
Table: Comparisons of Network Statistics in among graphs simulated from classical graph models and the observed network \label{tab:erwsdescstats}

Based on the results above, we see that the estimated average statistics for the Erdős-Rényi and Watts-Strogatz models are very similar to each other but are drastically different from many of the observed values of our Facebook network. This means that while the graphs generated from each model look very similar to each other, they look drastically different from our observed Facebook network. This is no surprise since the methods used to construct graphs under both models are very likely to generate almost the same number of verticles. We even see this in our simulation study; in the fourth row of `r ref("erwsdescstats", type = "table")`, the average degree estimate for both models was within one degree from each other. Additionally, in both constructions, we are adding the edges randomly, so they are almost always spread evenly throughout the $4039$ nodes. This means that additional features of the observed network, such as large clusters or degrees with high centralities, are likely to be missed by graphs generated from these two models. This is why the transitivity, average path length, and diameter for both models are smaller than what was actually observed. Similarly, because of how dispersed the edges are throughout the nodes, it is likely that there are many more nodes with higher centralities than in the observed network, making the average centrality measures for the graph models larger than those seen in the observed model. The only statistic whose value was actually close to, if not equal to, the observed value was the average degree. However, this makes sense since we fixed the probability $p$ of a link forming in the Erdős-Rényi model (which of is directly proportional to the average degree) and because we ensured that every graph generated from the Watts-Strogatz model has about the same number of edges as the observed network. Thus, we have shown through this simulation study that the Erdős-Rényi and Watts-Strogatz models are not very accurate in modeling our Facebook network for these particular network statistics. 





